---

- name: Debug ansible_facts
  debug:
    var: ansible_facts

- name: Install Windows Subsystem for Linux (wsl2)
  win_command: wsl --status
  register: wsl_status
  ignore_errors: yes
  changed_when: no

- name: Debug WSL install status
  debug:
    var: wsl_status

- debug:
    msg: "{{ wsl_status.stdout | to_yaml }}"

# all-in-one method
# Install WSL with a single command now available in Windows 10 version 2004 and higher
# https://devblogs.microsoft.com/commandline/install-wsl-with-a-single-command-now-available-in-windows-10-version-2004-and-higher/
# - name: Install Windows Subsystem for Linux (wsl2)
#   win_command: wsl --install
#   register: wsl_install
#   when:
#     - wsl_status is failed

# - name: Debug WSL install status
#   debug:
#     var: wsl_install

# - name: Reboot after WSL installation
#   win_reboot:
#   when: wsl_install is changed

- name: Enable WSL Windows features
  ansible.windows.win_optional_feature:
    name: "{{ item }}"
    state: present
  register: win_feature
  loop: "{{ win_features }}"

- name: Debug win_feature
  debug:
    var: win_feature

# - name: Reboot if WSL feature installation requires it
#   ansible.windows.win_reboot:
#   when: win_feature.reboot_required

- name: WSL download block
  block:

    - name: Create temporary directory
      ansible.windows.win_tempfile:
        state: directory
        suffix: wsl
      register: wsl_download_dir

    - name: Download earthrise.jpg to specified path
      ansible.windows.win_get_url:
        url: https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi
        dest: "{{ wsl_download_dir.path }}\\wsl_update_x64.msi"
  
    - name: Run wsl_update_x64.msi installer
      ansible.windows.win_command: "{{ wsl_download_dir.path }}\\wsl_update_x64.msi /quiet"
      register: wsl_update_x64

    - name: Debug wsl_update_x64
      debug:
        var: wsl_update_x64

  always:

    - name: Remove temp download directory
      ansible.windows.win_file:
        path: "{{ wsl_download_dir.path }}"
        state: absent
